<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è©©ã¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ - å­£ç¯€ã®ã‚³ãƒ¼ãƒ‰è©©ï¼ˆæŠ•ç¨¿ç”¨ï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #0a0a0a;
            color: white;
            font-family: 'Courier New', monospace;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        #controls {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h2 {
            color: #0ff;
            margin: 0 0 20px 0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        .info-box {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #0ff;
        }
        .info-box span {
            color: #0ff;
            font-weight: bold;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        #canvasContainer {
            display: flex;
            justify-content: center;
            background: #000;
            border: 2px solid #333;
            border-radius: 10px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="controls">
            <h2>ğŸŒ¸ è©©ã¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ - å­£ç¯€ã®ã‚³ãƒ¼ãƒ‰è©©</h2>
            
            <div class="info-grid">
                <div class="info-box">
                    <div>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰: <span id="previewModeText" style="color: #ff0;">Google Formç”¨</span></div>
                    <div style="font-size: 12px; color: #888;">Mã‚­ãƒ¼ã§åˆ‡ã‚Šæ›¿ãˆ</div>
                </div>
                <div class="info-box">
                    <div>ä½œå“ã‚µã‚¤ã‚º: <span id="workSizeText">960Ã—1620</span></div>
                    <div style="font-size: 12px; color: #888;">å®Ÿéš›ã®è§£åƒåº¦</div>
                </div>
                <div class="info-box">
                    <div>FPS: <span id="fps">60</span></div>
                    <div style="font-size: 12px; color: #888;">ç¾åœ¨ã®å­£ç¯€: <span id="currentSeason">æ˜¥</span></div>
                </div>
            </div>
            
            <div class="button-group">
                <button onclick="togglePreviewMode()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">ğŸ”„ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ (Google/NEORT)</button>
                <button onclick="exportGoogleForm()">ğŸ“¤ Google Formç”¨èª¬æ˜</button>
                <button onclick="exportNeort()">ğŸ“¤ NEORTç”¨èª¬æ˜</button>
                <button onclick="toggleGuide()">ğŸ“ ã‚¬ã‚¤ãƒ‰è¡¨ç¤º</button>
                <button onclick="resetAnimation()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,0,0.1); border: 1px solid #444; border-radius: 5px;">
                <div style="color: #ffa500; font-size: 12px; margin-bottom: 5px;">ğŸ“Œ æ“ä½œæ–¹æ³•</div>
                <div style="font-size: 11px; color: #aaa; line-height: 1.4;">
                    <strong>M:</strong> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆGoogle â‡” NEORTï¼‰<br>
                    <strong>S:</strong> ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ä¿å­˜ï¼ˆãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãï¼‰<br>
                    <strong>E:</strong> 15ç§’åˆ†é€£ç•ªæ›¸ãå‡ºã—ï¼ˆ900æšã€å‡¦ç†ãŒé‡ã„ï¼‰<br>
                    <strong>R:</strong> ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ | <strong>G:</strong> ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºåˆ‡æ›¿<br>
                    <strong>ä¿å­˜å…ˆ:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€
                </div>
            </div>
        </div>
        
        <div id="canvasContainer"></div>
    </div>

<script>
// ===============================================
// è¨­å®šå€¤
// ===============================================
const WORK_SCALE = 0.25; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆ25%ï¼‰

// Google Formç”¨
const GOOGLE_CANVAS_W = 3840;   // Google Formç”¨ã®æ¨ªå¹…
const GOOGLE_CANVAS_H = 2160;   // Google Formç”¨ã®é«˜ã•
const GOOGLE_WORK_W = 960;      // Google Formç”¨ã®ä½œå“å¹…
const GOOGLE_WORK_H = 1620;     // Google Formç”¨ã®ä½œå“é«˜ã•

// NEORTç”¨
const NEORT_W = 2160;           // NEORTç”¨ã®å¹…ï¼ˆä½œå“ã‚µã‚¤ã‚ºãã®ã¾ã¾ï¼‰
const NEORT_H = 3840;           // NEORTç”¨ã®é«˜ã•ï¼ˆä½œå“ã‚µã‚¤ã‚ºãã®ã¾ã¾ï¼‰

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰
let previewMode = 'google'; // 'google' or 'neort'

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚µã‚¤ã‚ºï¼ˆãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦å‹•çš„ã«å¤‰æ›´ï¼‰
let previewW, previewH, workW, workH;

// ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
let showGuide = true;

// ===============================================
// å­£ç¯€ã®ã‚³ãƒ¼ãƒ‰è©©ã®å¤‰æ•°
// ===============================================
let d; // ãƒ‡ãƒ¼ã‚¿å®šç¾©
let f = []; // é™ã£ã¦ãã‚‹è¦ç´ ã®é…åˆ—
let l = 0.0; // lerpç”¨ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
let s; // å­£ç¯€ã®é…åˆ—
let cs; // ç¾åœ¨ã®å­£ç¯€
let ns; // æ¬¡ã®å­£ç¯€
let seasonStartTime;
let frameCounter = 0;
let generationPhase = 0;
const SEASON_DURATION = 3750; // å„å­£ç¯€ã®é•·ã•ï¼ˆãƒŸãƒªç§’ï¼‰

// æ›¸ãå‡ºã—ç”¨ã®é«˜è§£åƒåº¦ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹
let exportGraphics = null;
let isExporting = false;

// ===============================================
// p5.js ãƒ¡ã‚¤ãƒ³
// ===============================================
function setup() {
    // åˆæœŸãƒ¢ãƒ¼ãƒ‰è¨­å®š
    previewMode = 'google';
    updateCanvasSize();
    
    let canvas = createCanvas(previewW, previewH);
    canvas.parent('canvasContainer');
    
    // å­£ç¯€ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
    initSeasonData();
    seasonStartTime = millis();
    generateFlakes();
}

function updateCanvasSize() {
    if (previewMode === 'google') {
        // Google Formç”¨: 3840Ã—2160ã®25%ã€ä½œå“ã¯960Ã—1620
        previewW = 960;
        previewH = 540;
        workW = GOOGLE_WORK_W * WORK_SCALE;  // 240
        workH = GOOGLE_WORK_H * WORK_SCALE;  // 405
    } else {
        // NEORTç”¨: 2160Ã—3840ã®25% = 540Ã—960ï¼ˆä½œå“ãŒå…¨ç”»é¢ï¼‰
        previewW = NEORT_W * WORK_SCALE;  // 540
        previewH = NEORT_H * WORK_SCALE;  // 960
        workW = previewW;  // 540ï¼ˆå…¨ç”»é¢ï¼‰
        workH = previewH;  // 960ï¼ˆå…¨ç”»é¢ï¼‰
    }
}

function initSeasonData() {
    // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸã‚µã‚¤ã‚ºã‚¹ã‚±ãƒ¼ãƒ«
    let sizeScale = previewMode === 'google' ? 1 : 2.25; // NEORTã¯2.25å€å¤§ãã„
    
    // ãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆå­£ç¯€ã®è©©çš„è¡¨ç¾ï¼‰
    d = {
        s: { // æ˜¥ï¼ˆSpringï¼‰- èŠ±
            c: 'âœ¿',
            r: true,
            s: 12 * sizeScale,  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚ºã«èª¿æ•´
            co: [255, 105, 180],
            bg: [255, 182, 193],
            code: "æ˜¥.tender('âœ¿', :bloom)",
            name: "æ˜¥"
        },
        u: { // å¤ï¼ˆSummerï¼‰- ã‚»ãƒŸã‚³ãƒ­ãƒ³ï¼ˆæ°´æ»´ã®ãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ï¼‰
            c: ';',
            r: false,
            s: 10 * sizeScale,  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚ºã«èª¿æ•´
            co: [30, 144, 255],
            bg: [135, 206, 250],
            code: "å¤.sudden(';', :pour)",
            name: "å¤"
        },
        a: { // ç§‹ï¼ˆAutumnï¼‰- ã‚¹ãƒšãƒ¼ãƒ‰ï¼ˆè½è‘‰ã®ãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ï¼‰
            c: 'â™ ',
            r: true,
            s: 11 * sizeScale,  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚ºã«èª¿æ•´
            co: [204, 85, 0],
            bg: [204, 163, 0],
            code: "ç§‹.gradual('â™ ', :fall)",
            name: "ç§‹"
        },
        w: { // å†¬ï¼ˆWinterï¼‰- é›ªã®çµæ™¶
            c: '*',
            r: false,
            s: 15 * sizeScale,  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚ºã«èª¿æ•´
            co: [255, 255, 255],
            bg: [0, 31, 63],
            code: "å†¬.silent('*', :float)",
            name: "å†¬"
        }
    };
    
    s = ['s', 'u', 'a', 'w'];
    cs = 's';  // ç¾åœ¨ã®å­£ç¯€ï¼šæ˜¥
    ns = 'u';  // æ¬¡ã®å­£ç¯€ï¼šå¤
}

function draw() {
    // é»’èƒŒæ™¯
    background(0);
    
    // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸé…ç½®
    push();
    if (previewMode === 'google') {
        // Google Formç”¨: å·¦ä¸Šé…ç½®
        translate(0, 0);
    } else {
        // NEORTç”¨: å…¨ç”»é¢ï¼ˆé…ç½®ã®å¿…è¦ãªã—ï¼‰
        translate(0, 0);
    }
    
    // ä½œå“ã®æç”»
    drawPoetryWork();
    
    pop();
    
    // Google Formç”¨ã®å ´åˆã®ã¿ã€ä½œå“ã‚¨ãƒªã‚¢å¤–ã‚’é»’ã§ãƒã‚¹ã‚¯
    if (previewMode === 'google') {
        fill(0);
        noStroke();
        rect(GOOGLE_WORK_W * WORK_SCALE, 0, previewW, previewH);  // å³å´å…¨ä½“
        rect(0, GOOGLE_WORK_H * WORK_SCALE, GOOGLE_WORK_W * WORK_SCALE, previewH);  // å·¦ä¸‹éƒ¨åˆ†
    }
    
    // ã‚¬ã‚¤ãƒ‰ã®è¡¨ç¤º
    if (showGuide) {
        drawGuides();
    }
    
    // FPSè¡¨ç¤º
    if (frameCount % 10 === 0) {
        document.getElementById('fps').textContent = Math.round(frameRate());
        document.getElementById('currentSeason').textContent = d[cs].name;
        
        let modeElement = document.getElementById('previewModeText');
        if (modeElement) {
            modeElement.textContent = previewMode === 'google' ? 'Google Formç”¨' : 'NEORTç”¨';
        }
        
        let sizeElement = document.getElementById('workSizeText');
        if (sizeElement) {
            if (previewMode === 'google') {
                sizeElement.textContent = `${GOOGLE_WORK_W}Ã—${GOOGLE_WORK_H}`;
            } else {
                sizeElement.textContent = `${NEORT_W}Ã—${NEORT_H}`;
            }
        }
    }
    
    frameCounter++;
}

function drawPoetryWork() {
    // ä½œå“ã‚¨ãƒªã‚¢ã®èƒŒæ™¯
    push();
    
    // èƒŒæ™¯ã®æ›´æ–°
    updateBackground();
    
    // å­£ç¯€ã®é·ç§»å‡¦ç†
    handleTransition();
    
    // æ®µéšçš„ç”Ÿæˆã®å‡¦ç†
    if (generationPhase < 3) {
        generateFlakesPhase();
    }
    
    // å­£ç¯€ã®ã‚³ãƒ¼ãƒ‰è©©ã‚’è¡¨ç¤º
    displayPoetryCode();
    
    // é™ã‚‹è¦ç´ ã®æç”»
    renderFlakes();
    
    pop();
}

function updateBackground() {
    // æ™‚é–“ãƒ™ãƒ¼ã‚¹ã§é€²è¡Œåº¦ã‚’è¨ˆç®—
    let elapsed = millis() - seasonStartTime;
    l = min(elapsed / SEASON_DURATION, 1.0);
    
    let currentBg = color(...d[cs].bg);
    let nextBg = color(...d[ns].bg);
    
    // å‰åŠã¯ç¾åœ¨ã®å­£ç¯€ã®è‰²ã€å¾ŒåŠã‹ã‚‰æ¬¡ã®å­£ç¯€ã¸é·ç§»
    let lerpAmount = l < 0.5 ? 0 : map(l, 0.5, 1, 0, 1);
    let bg = lerpColor(currentBg, nextBg, lerpAmount);
    
    fill(bg);
    noStroke();
    rect(0, 0, workW, workH);
}

function handleTransition() {
    if (l >= 1) {
        // å­£ç¯€ã‚’åˆ‡ã‚Šæ›¿ãˆ
        cs = ns;
        let currentIndex = s.indexOf(cs);
        let nextIndex = (currentIndex + 1) % 4;
        ns = s[nextIndex];
        
        // ã‚¿ã‚¤ãƒãƒ¼ã¨é€²è¡Œåº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
        seasonStartTime = millis();
        l = 0;
        
        // å‰ã®å­£ç¯€ã®è¦ç´ ã‚’ã‚¯ãƒªã‚¢
        f = [];
        
        generateFlakes();
    }
}

function generateFlakes() {
    // ç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚ºã‚’ãƒªã‚»ãƒƒãƒˆ
    generationPhase = 0;
    generateFlakesPhase();
}

function generateFlakesPhase() {
    let elapsed = millis() - seasonStartTime;
    
    // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸä½ç½®ã‚¹ã‚±ãƒ¼ãƒ«
    let posScale = previewMode === 'google' ? 1 : 2.25;
    
    // æ™‚é–“ãƒ™ãƒ¼ã‚¹ã§æ®µéšçš„ã«ç”Ÿæˆ
    if (generationPhase === 0) {
        // ç¬¬1æ³¢ï¼šå³åº§ã«ï¼ˆ50å€‹ï¼‰
        for (let i = 0; i < 50; i++) {
            f.push(new Flake(
                random(10, workW - 10),  // å¢ƒç•Œå†…ã«ç”Ÿæˆ
                random(-80 * posScale, -5 * posScale),
                d[cs].c,
                d[cs].co,
                random(d[cs].s * 0.8, d[cs].s * 1.2),
                d[cs].r
            ));
        }
        generationPhase = 1;
    } else if (generationPhase === 1 && elapsed > 400) {
        // ç¬¬2æ³¢ï¼š400mså¾Œï¼ˆ30å€‹ï¼‰
        for (let i = 0; i < 30; i++) {
            f.push(new Flake(
                random(10, workW - 10),  // å¢ƒç•Œå†…ã«ç”Ÿæˆ
                random(-60 * posScale, -5 * posScale),
                d[cs].c,
                d[cs].co,
                random(d[cs].s * 0.7, d[cs].s * 1.1),
                d[cs].r
            ));
        }
        generationPhase = 2;
    } else if (generationPhase === 2 && elapsed > 800) {
        // ç¬¬3æ³¢ï¼š800mså¾Œï¼ˆ20å€‹ï¼‰
        for (let i = 0; i < 20; i++) {
            f.push(new Flake(
                random(10, workW - 10),  // å¢ƒç•Œå†…ã«ç”Ÿæˆ
                random(-40 * posScale, -5 * posScale),
                d[cs].c,
                d[cs].co,
                random(d[cs].s * 0.6, d[cs].s * 1.0),
                d[cs].r
            ));
        }
        generationPhase = 3; // å®Œäº†
    }
}

function displayPoetryCode() {
    push();
    // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸã‚µã‚¤ã‚ºã‚¹ã‚±ãƒ¼ãƒ«
    let sizeScale = previewMode === 'google' ? 1 : 2.25;
    
    // ã‚³ãƒ¼ãƒ‰è©©ã‚’ä¸­å¤®ã«è¡¨ç¤º
    fill(255, 255, 255, 100);
    textSize(8 * sizeScale);  // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦èª¿æ•´
    textAlign(CENTER, CENTER);
    textFont('monospace');
    text(d[cs].code, workW/2, workH/2);
    
    // ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆ
    textSize(5 * sizeScale);  // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦èª¿æ•´
    fill(255, 255, 255, 60);
    text("#Computer_Poetry_TOKYO_NODE", workW/2, workH/2 + 15 * sizeScale);
    pop();
}

function renderFlakes() {
    // ç”»é¢å¤–ã®è¦ç´ ã‚’å‰Šé™¤ã—ãªãŒã‚‰æç”»
    f = f.filter(flake => {
        flake.update();
        flake.display();
        return !flake.isOffscreen();
    });
}

class Flake {
    constructor(x, y, char, col, size, rotate) {
        this.x = constrain(x, 0, workW);  // åˆæœŸä½ç½®ã‚’å¢ƒç•Œå†…ã«åˆ¶é™
        this.y = y;
        this.char = char;
        this.col = col;
        this.size = size;
        this.shouldRotate = rotate;
        this.rotation = rotate ? random(TWO_PI) : 0;
        
        // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸé€Ÿåº¦èª¿æ•´
        let speedScale = previewMode === 'google' ? 1 : 2.25;
        
        // 3ã¤ã®é€Ÿåº¦ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ3.75ç§’ã§ç¢ºå®Ÿã«è½ã¡åˆ‡ã‚‹é€Ÿåº¦ï¼‰
        let speedGroup = random();
        if (speedGroup < 0.3) {
            this.speed = random(2.5, 3.5) * speedScale;  // ã‚†ã£ãã‚Š
        } else if (speedGroup < 0.7) {
            this.speed = random(3.5, 4.5) * speedScale;  // æ™®é€š
        } else {
            this.speed = random(4.5, 6) * speedScale; // é€Ÿã„
        }
        
        this.velocity = rotate ? random(-0.5, 0.5) * speedScale : 0;  // æ¨ªç§»å‹•é€Ÿåº¦ã‚’åˆ¶é™
        this.opacity = 255;
        this.baseOpacity = random(180, 255);
    }
    
    update() {
        // é‡åŠ›åŠ é€Ÿã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        this.speed *= 1.002;
        this.y += this.speed;
        this.x += this.velocity;
        
        // æ¨ªã®å‹•ãã«æ³¢ã‚’åŠ ãˆã‚‹
        this.x += sin(frameCounter * 0.01 + this.y * 0.01) * 0.15;
        
        // å·¦å³ã®å¢ƒç•Œã§ãƒã‚¦ãƒ³ã‚¹
        if (this.x < 0) this.x = 0;
        if (this.x > workW) this.x = workW;
        
        if (this.shouldRotate) {
            this.rotation += 0.03;
        }
        
        // ç”»é¢ä¸‹éƒ¨ã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
        if (this.y > workH * 0.7) {
            this.opacity = map(this.y, workH * 0.7, workH, this.baseOpacity, 0);
        } else {
            this.opacity = this.baseOpacity;
        }
    }
    
    display() {
        // ä½œå“ã‚¨ãƒªã‚¢å†…ã«ã‚ã‚‹å ´åˆã®ã¿æç”»
        if (this.x >= -this.size && this.x <= workW + this.size && 
            this.y >= -this.size && this.y <= workH + this.size) {
            push();
            translate(this.x, this.y);
            rotate(this.rotation);
            fill(this.col[0], this.col[1], this.col[2], this.opacity);
            textSize(this.size);
            textFont('monospace');
            textAlign(CENTER, CENTER);
            text(this.char, 0, 0);
            pop();
        }
    }
    
    isOffscreen() {
        return this.y > workH + 20;
    }
}

function drawGuides() {
    push();
    
    // ä½œå“ã‚¨ãƒªã‚¢ã®æ ç·š
    stroke(0, 255, 255, 100);
    strokeWeight(1);
    noFill();
    
    if (previewMode === 'google') {
        // Google Formç”¨: å·¦ä¸Šã®ä½œå“ã‚¨ãƒªã‚¢
        rect(0, 0, GOOGLE_WORK_W * WORK_SCALE, GOOGLE_WORK_H * WORK_SCALE);
    } else {
        // NEORTç”¨: å…¨ç”»é¢ãŒä½œå“ã‚¨ãƒªã‚¢
        rect(0, 0, workW, workH);
    }
    
    // ä¸­å¿ƒç·šï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ï¼‰
    stroke(255, 0, 255, 50);
    line(previewW / 2, 0, previewW / 2, previewH);
    line(0, previewH / 2, previewW, previewH / 2);
    
    // ã‚µã‚¤ã‚ºæƒ…å ±
    fill(0, 255, 255);
    noStroke();
    textSize(10);
    textAlign(LEFT, TOP);
    
    if (previewMode === 'google') {
        text(`ä½œå“: ${GOOGLE_WORK_W}Ã—${GOOGLE_WORK_H}`, 5, GOOGLE_WORK_H * WORK_SCALE + 5);
        text(`ã‚­ãƒ£ãƒ³ãƒã‚¹: ${GOOGLE_CANVAS_W}Ã—${GOOGLE_CANVAS_H}`, 5, GOOGLE_WORK_H * WORK_SCALE + 20);
        text('å·¦ä¸Šé…ç½® (Google Formç”¨)', 5, GOOGLE_WORK_H * WORK_SCALE + 35);
    } else {
        text(`ä½œå“: ${NEORT_W}Ã—${NEORT_H}`, 5, 5);
        text('å…¨ç”»é¢ (NEORTç”¨)', 5, 20);
        text('ä½™ç™½ãªã—', 5, 35);
    }
    
    pop();
}

// ===============================================
// æ›¸ãå‡ºã—æ©Ÿèƒ½ï¼ˆèª¬æ˜ï¼‰
// ===============================================
function exportGoogleForm() {
    let msg = `ğŸ“¤ Google Formç”¨æ›¸ãå‡ºã—æ‰‹é †\n\n`;
    msg += `ã€è§£åƒåº¦ã€‘3840Ã—2160ï¼ˆæ¨ªé•·ï¼‰\n`;
    msg += `ã€ä½œå“ã€‘960Ã—1620ã‚’å·¦ä¸Šã«é…ç½®ï¼ˆæ®‹ã‚Šé»’ä½™ç™½ï¼‰\n\n`;
    msg += `ã€ç¢ºèªæ–¹æ³•ã€‘\n`;
    msg += `1. Mã‚­ãƒ¼ã§ã€ŒGoogle Formç”¨ã€ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ\n`;
    msg += `2. æ¨ªé•·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å·¦ä¸Šé…ç½®ã‚’ç¢ºèª\n\n`;
    msg += `ã€æ›¸ãå‡ºã—æ–¹æ³•ã€‘\n`;
    msg += `1. Google Formãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆMã‚­ãƒ¼ï¼‰\n`;
    msg += `2. Rã‚­ãƒ¼ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ\n`;
    msg += `3. Eã‚­ãƒ¼ã§15ç§’åˆ†ã®é€£ç•ªç”»åƒã‚’è‡ªå‹•ä¿å­˜\n`;
    msg += `   â€»ãƒ•ã‚¡ã‚¤ãƒ«åã«'google_'ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ã\n`;
    msg += `4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã«900æšã®PNGãŒä¿å­˜ã•ã‚Œã¾ã™\n\n`;
    msg += `ã€å‹•ç”»åŒ–ã€‘\n`;
    msg += `ffmpeg -r 60 -i google_poetry_computer_%04d.png -c:v libx264 -pix_fmt yuv420p -crf 18 googleform.mp4`;
    
    alert(msg);
    
    console.log('=== Google Formç”¨æ›¸ãå‡ºã— ===');
    console.log('ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ï¼š', previewMode === 'google' ? 'âœ… Google Formç”¨' : 'âŒ NEORTç”¨ï¼ˆMã‚­ãƒ¼ã§åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ï¼‰');
    console.log('ç”»åƒãŒä¿å­˜ã•ã‚ŒãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å‹•ç”»åŒ–ï¼š');
    console.log('ffmpeg -r 60 -i google_poetry_computer_%04d.png -c:v libx264 -pix_fmt yuv420p -crf 18 googleform.mp4');
}

function exportNeort() {
    let msg = `ğŸ“¤ NEORTç”¨æ›¸ãå‡ºã—æ‰‹é †\n\n`;
    msg += `ã€è§£åƒåº¦ã€‘2160Ã—3840ï¼ˆç¸¦é•·ï¼‰\n`;
    msg += `ã€ä½œå“ã€‘å…¨ç”»é¢ï¼ˆä½™ç™½ãªã—ï¼‰\n\n`;
    msg += `ã€ç¢ºèªæ–¹æ³•ã€‘\n`;
    msg += `1. Mã‚­ãƒ¼ã§ã€ŒNEORTç”¨ã€ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ\n`;
    msg += `2. ç¸¦é•·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å…¨ç”»é¢è¡¨ç¤ºã‚’ç¢ºèª\n\n`;
    msg += `ã€æ›¸ãå‡ºã—æ–¹æ³•ã€‘\n`;
    msg += `1. NEORTãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆMã‚­ãƒ¼ï¼‰\n`;
    msg += `2. Rã‚­ãƒ¼ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ\n`;
    msg += `3. Eã‚­ãƒ¼ã§15ç§’åˆ†ã®é€£ç•ªç”»åƒã‚’è‡ªå‹•ä¿å­˜\n`;
    msg += `   â€»ãƒ•ã‚¡ã‚¤ãƒ«åã«'neort_'ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ã\n`;
    msg += `4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã«900æšã®PNGãŒä¿å­˜ã•ã‚Œã¾ã™\n\n`;
    msg += `ã€å‹•ç”»åŒ–ã€‘\n`;
    msg += `ffmpeg -r 60 -i neort_poetry_computer_%04d.png -c:v libx264 -pix_fmt yuv420p -crf 18 neort.mp4`;
    
    alert(msg);
    
    console.log('=== NEORTç”¨æ›¸ãå‡ºã— ===');
    console.log('ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ï¼š', previewMode === 'neort' ? 'âœ… NEORTç”¨' : 'âŒ Google Formç”¨ï¼ˆMã‚­ãƒ¼ã§åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ï¼‰');
    console.log('ç”»åƒãŒä¿å­˜ã•ã‚ŒãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å‹•ç”»åŒ–ï¼š');
    console.log('ffmpeg -r 60 -i neort_poetry_computer_%04d.png -c:v libx264 -pix_fmt yuv420p -crf 18 neort.mp4');
}

// ===============================================
// æ“ä½œé–¢æ•°
// ===============================================
function togglePreviewMode() {
    previewMode = previewMode === 'google' ? 'neort' : 'google';
    updateCanvasSize();
    resizeCanvas(previewW, previewH);
    
    // å­£ç¯€ãƒ‡ãƒ¼ã‚¿ã‚’å†åˆæœŸåŒ–ï¼ˆã‚µã‚¤ã‚ºèª¿æ•´ã®ãŸã‚ï¼‰
    initSeasonData();
    
    console.log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸï¼š', previewMode === 'google' ? 'Google Formç”¨' : 'NEORTç”¨');
    
    // UIã‚’æ›´æ–°
    let modeElement = document.getElementById('previewModeText');
    let sizeElement = document.getElementById('workSizeText');
    
    if (modeElement) {
        modeElement.textContent = previewMode === 'google' ? 'Google Formç”¨' : 'NEORTç”¨';
    }
    if (sizeElement) {
        if (previewMode === 'google') {
            sizeElement.textContent = `${GOOGLE_WORK_W}Ã—${GOOGLE_WORK_H}`;
        } else {
            sizeElement.textContent = `${NEORT_W}Ã—${NEORT_H}`;
        }
    }
}

function toggleGuide() {
    showGuide = !showGuide;
}

function resetAnimation() {
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    frameCounter = 0;
    l = 0;
    cs = 's';
    ns = 'u';
    f = [];
    generationPhase = 0;
    seasonStartTime = millis();
    generateFlakes();
}

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
function keyPressed() {
    if (key === 'm' || key === 'M') {
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        togglePreviewMode();
    } else if (key === 'g' || key === 'G') {
        toggleGuide();
    } else if (key === 'r' || key === 'R') {
        resetAnimation();
    } else if (key === 's' || key === 'S') {
        // ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä¿å­˜ï¼ˆãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãï¼‰
        let prefix = previewMode === 'google' ? 'google_' : 'neort_';
        saveCanvas(prefix + 'poetry_computer_' + frameCount, 'png');
        console.log('ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸï¼š' + prefix + 'poetry_computer_' + frameCount + '.png');
        console.log('ãƒ¢ãƒ¼ãƒ‰ï¼š', previewMode === 'google' ? 'Google Formç”¨ï¼ˆ3840Ã—2160ï¼‰' : 'NEORTç”¨ï¼ˆ2160Ã—3840ï¼‰');
    } else if (key === 'e' || key === 'E') {
        // é€£ç•ªæ›¸ãå‡ºã—ã‚’é–‹å§‹ï¼ˆ15ç§’åˆ†ï¼‰
        let prefix = previewMode === 'google' ? 'google_' : 'neort_';
        console.log('15ç§’é–“ã®é€£ç•ªç”»åƒæ›¸ãå‡ºã—ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆ' + (previewMode === 'google' ? 'Google Formç”¨' : 'NEORTç”¨') + 'ï¼‰...');
        saveFrames(prefix + 'poetry_computer', 'png', 15 * 60, 60, (result) => {
            console.log('æ›¸ãå‡ºã—å®Œäº†ï¼', result.length, 'æšã®ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
            console.log('ffmpegã‚³ãƒãƒ³ãƒ‰ï¼š');
            console.log(`ffmpeg -r 60 -i ${prefix}poetry_computer_%04d.png -c:v libx264 -pix_fmt yuv420p -crf 18 output_${previewMode}.mp4`);
        });
    }
}
</script>
</body>
</html>
