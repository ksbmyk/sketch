<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è©©ã¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ - å­£ç¯€ã®ã‚³ãƒ¼ãƒ‰è©©ï¼ˆç§‹ã®åºƒãŒã‚Šç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #0a0a0a;
            color: white;
            font-family: 'Courier New', monospace;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        #controls {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h2 {
            color: #0ff;
            margin: 0 0 20px 0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        .info-box {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #0ff;
        }
        .info-box span {
            color: #0ff;
            font-weight: bold;
        }
        .export-status {
            background: rgba(255,0,0,0.2);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .export-status.active {
            display: block;
            background: rgba(0,255,0,0.2);
        }
        .export-status.saving {
            background: rgba(255,255,0,0.2);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #canvasContainer {
            display: flex;
            justify-content: center;
            background: #000;
            border: 2px solid #333;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0ff, #00ff88);
            transition: width 0.3s;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="controls">
            <h2>ğŸŒ¸ è©©ã¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ - å­£ç¯€ã®ã‚³ãƒ¼ãƒ‰è©©ï¼ˆç§‹ã®åºƒãŒã‚Šç‰ˆï¼‰</h2>
            
            <div class="info-grid">
                <div class="info-box">
                    <div>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰: <span id="previewModeText" style="color: #ff0;">Google Formç”¨</span></div>
                    <div style="font-size: 12px; color: #888;">Mã‚­ãƒ¼ã§åˆ‡ã‚Šæ›¿ãˆ</div>
                </div>
                <div class="info-box">
                    <div>ä½œå“ã‚µã‚¤ã‚º: <span id="workSizeText">960Ã—1620</span></div>
                    <div style="font-size: 12px; color: #888;">å®Ÿéš›ã®è§£åƒåº¦</div>
                </div>
                <div class="info-box">
                    <div>FPS: <span id="fps">60</span></div>
                    <div style="font-size: 12px; color: #888;">ç¾åœ¨ã®å­£ç¯€: <span id="currentSeason">æ˜¥</span></div>
                </div>
            </div>
            
            <div class="export-status" id="exportStatus">
                <div id="exportStatusText">ğŸ“¸ ãƒ•ãƒ¬ãƒ¼ãƒ ç”Ÿæˆä¸­...</div>
                <div>ãƒ•ãƒ¬ãƒ¼ãƒ : <span id="exportFrame">0</span> / <span id="totalFrames">900</span></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div style="font-size: 12px; color: #aaa; margin-top: 5px;" id="exportMessage">å‡¦ç†ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™</div>
            </div>
            
            <div class="button-group">
                <button onclick="togglePreviewMode()">ğŸ”„ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ (Google/NEORT)</button>
                <button onclick="exportHighResGoogle()" id="exportGoogleBtn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">ğŸ“¸ Google Formç”¨ é«˜è§£åƒåº¦æ›¸ãå‡ºã—</button>
                <button onclick="exportHighResNeort()" id="exportNeortBtn" style="background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);">ğŸ“¸ NEORTç”¨ é«˜è§£åƒåº¦æ›¸ãå‡ºã—</button>
                <button onclick="toggleGuide()">ğŸ“ ã‚¬ã‚¤ãƒ‰è¡¨ç¤º</button>
                <button onclick="resetAnimation()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,0,0.1); border: 1px solid #444; border-radius: 5px;">
                <div style="color: #ffa500; font-size: 12px; margin-bottom: 5px;">ğŸ“Œ æ“ä½œæ–¹æ³•</div>
                <div style="font-size: 11px; color: #aaa; line-height: 1.4;">
                    <strong>M:</strong> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆGoogle â‡” NEORTï¼‰<br>
                    <strong>S:</strong> ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ä¿å­˜ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚ºï¼‰<br>
                    <strong>é«˜è§£åƒåº¦æ›¸ãå‡ºã—:</strong> 900ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é€£ç•ªã§ç¢ºå®Ÿã«ä¿å­˜<br>
                    <strong>R:</strong> ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ | <strong>G:</strong> ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºåˆ‡æ›¿<br>
                    <strong>ä¿å­˜å…ˆ:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€
                </div>
            </div>
        </div>
        
        <div id="canvasContainer"></div>
    </div>

<script>
// ===============================================
// è¨­å®šå€¤
// ===============================================
const WORK_SCALE = 0.25; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆ25%ï¼‰

// Google Formç”¨
const GOOGLE_CANVAS_W = 3840;   
const GOOGLE_CANVAS_H = 2160;   
const GOOGLE_WORK_W = 960;      
const GOOGLE_WORK_H = 1620;     

// NEORTç”¨
const NEORT_W = 2160;           
const NEORT_H = 3840;           

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰
let previewMode = 'google'; 

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚µã‚¤ã‚º
let previewW, previewH, workW, workH;

// ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
let showGuide = true;

// é«˜è§£åƒåº¦æ›¸ãå‡ºã—ç”¨
let exportGraphics = null;
let isExporting = false;
let exportFrameCount = 0;
let exportMode = '';

// é€£ç•ªä¿å­˜ç”¨ã®æ–°ã—ã„å¤‰æ•°
let pendingFrames = [];  // ä¿å­˜å¾…ã¡ãƒ•ãƒ¬ãƒ¼ãƒ 
let isSaving = false;     // ä¿å­˜å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°
let saveIndex = 0;        // ç¾åœ¨ä¿å­˜ä¸­ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

// ===============================================
// å­£ç¯€ã®ã‚³ãƒ¼ãƒ‰è©©ã®å¤‰æ•°
// ===============================================
let d; 
let f = []; 
let l = 0.0; 
let s; 
let cs; 
let ns; 
let seasonStartTime;
let frameCounter = 0;
let generationPhase = 0;
const SEASON_DURATION = 3750; 

// é«˜è§£åƒåº¦æ›¸ãå‡ºã—ç”¨ã®å¤‰æ•°
let exportFlakes = []; 
let exportGenerationPhase = 0;

// ===============================================
// p5.js ãƒ¡ã‚¤ãƒ³
// ===============================================
function setup() {
    pixelDensity(1);
    
    previewMode = 'google';
    updateCanvasSize();
    
    let canvas = createCanvas(previewW, previewH);
    canvas.parent('canvasContainer');
    
    // â˜…ãƒ•ã‚©ãƒ³ãƒˆã‚’ä¸€åº¦ã ã‘è¨­å®šï¼ˆæœ€é©åŒ–ï¼‰
    textFont('monospace');
    
    initSeasonData();
    seasonStartTime = millis();
    generateFlakes();
}

function updateCanvasSize() {
    if (previewMode === 'google') {
        previewW = 960;
        previewH = 540;
        workW = GOOGLE_WORK_W * WORK_SCALE;  
        workH = GOOGLE_WORK_H * WORK_SCALE;  
    } else {
        previewW = NEORT_W * WORK_SCALE;  
        previewH = NEORT_H * WORK_SCALE;  
        workW = previewW;  
        workH = previewH;  
    }
}

function initSeasonData() {
    let sizeScale;
    if (isExporting) {
        sizeScale = exportMode === 'google' ? 4 : 9;
    } else {
        sizeScale = previewMode === 'google' ? 1 : 2.25;
    }
    
    d = {
        s: { // æ˜¥
            c: 'âœ¿',
            r: true,
            s: 12 * sizeScale,  
            co: [255, 100, 210],
            bg: [255, 182, 193],
            code: "æ˜¥.tender('âœ¿', :bloom)",
            name: "æ˜¥"
        },
        u: { // å¤
            c: ';',
            r: false,
            s: 10 * sizeScale,  
            co: [0, 30, 180],
            bg: [135, 206, 250],
            code: "å¤.sudden(';', :pour)",
            name: "å¤"
        },
        a: { // ç§‹
            c: 'â™ ',
            r: true,
            s: 15 * sizeScale,
            co: [204, 85, 0],
            bg: [204, 163, 0],
            code: "ç§‹.gradual('â™ ', :fall)",
            name: "ç§‹"
        },
        w: { // å†¬
            c: '*',
            r: true,  // é›ªã‚‚å›è»¢ã•ã›ã‚‹
            s: 15 * sizeScale,
            co: [255, 255, 255],
            bg: [0, 31, 63],
            code: "å†¬.silent('*', :float)",
            name: "å†¬"
        }
    };
    
    s = ['s', 'u', 'a', 'w'];
    cs = 's';  
    ns = 'u';  
}

function draw() {
    if (isExporting && !isSaving) {
        // ãƒ•ãƒ¬ãƒ¼ãƒ ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰
        generateHighResFrame();
        return;
    } else if (isSaving) {
        // ä¿å­˜å‡¦ç†ä¸­ã¯æç”»ã‚’åœæ­¢
        return;
    }
    
    // é€šå¸¸ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”»
    background(0);
    
    drawPoetryWork();
    
    if (previewMode === 'google') {
        fill(0);
        noStroke();
        rect(GOOGLE_WORK_W * WORK_SCALE, 0, previewW, previewH);  
        rect(0, GOOGLE_WORK_H * WORK_SCALE, GOOGLE_WORK_W * WORK_SCALE, previewH);  
    }
    
    if (showGuide) {
        drawGuides();
    }
    
    if (frameCount % 10 === 0) {
        updateUI();
    }
    
    frameCounter++;
}

// é«˜è§£åƒåº¦ãƒ•ãƒ¬ãƒ¼ãƒ ç”Ÿæˆï¼ˆãƒ¡ãƒ¢ãƒªã«ä¿å­˜ï¼‰
function generateHighResFrame() {
    if (!exportGraphics) return;
    
    exportGraphics.clear();
    
    if (exportMode === 'google') {
        exportGraphics.background(0);
        exportGraphics.push();
        exportGraphics.drawingContext.save();
        exportGraphics.drawingContext.beginPath();
        exportGraphics.drawingContext.rect(0, 0, GOOGLE_WORK_W, GOOGLE_WORK_H);
        exportGraphics.drawingContext.clip();
        
        workW = GOOGLE_WORK_W;
        workH = GOOGLE_WORK_H;
        drawPoetryWorkHighRes(exportGraphics);
        
        exportGraphics.drawingContext.restore();
        exportGraphics.pop();
        
        exportGraphics.fill(0);
        exportGraphics.noStroke();
        exportGraphics.rect(GOOGLE_WORK_W, 0, GOOGLE_CANVAS_W - GOOGLE_WORK_W, GOOGLE_CANVAS_H);
        exportGraphics.rect(0, GOOGLE_WORK_H, GOOGLE_WORK_W, GOOGLE_CANVAS_H - GOOGLE_WORK_H);
    } else {
        workW = NEORT_W;
        workH = NEORT_H;
        drawPoetryWorkHighRes(exportGraphics);
    }
    
    // Canvas ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆãƒ¡ãƒ¢ãƒªã«ï¼‰
    let imageData = exportGraphics.canvas.toDataURL('image/png');
    pendingFrames.push({
        data: imageData,
        filename: `${exportMode}_frame_${nf(exportFrameCount, 4)}.png`,
        frameNumber: exportFrameCount
    });
    
    exportFrameCount++;
    
    // é€²æ—æ›´æ–°
    document.getElementById('exportFrame').textContent = exportFrameCount;
    let progress = (exportFrameCount / 900) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    
    // 900ãƒ•ãƒ¬ãƒ¼ãƒ ç”Ÿæˆå®Œäº†
    if (exportFrameCount >= 900) {
        console.log('ãƒ•ãƒ¬ãƒ¼ãƒ ç”Ÿæˆå®Œäº†ã€‚é †æ¬¡ä¿å­˜ã‚’é–‹å§‹ã—ã¾ã™...');
        startSequentialSave();
    }
}

// é †æ¬¡ä¿å­˜å‡¦ç†ï¼ˆé€£ç•ªã‚’ç¢ºå®Ÿã«ç¶­æŒï¼‰
function startSequentialSave() {
    isSaving = true;
    saveIndex = 0;
    
    // UIã‚’æ›´æ–°
    document.getElementById('exportStatus').classList.add('saving');
    document.getElementById('exportStatusText').textContent = 'ğŸ’¾ é †æ¬¡ä¿å­˜ä¸­...';
    document.getElementById('exportMessage').textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‡ºãŸã‚‰ã€Œè¨±å¯ã€ã‚’é¸æŠã—ã¦ãã ã•ã„';
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    document.getElementById('exportGoogleBtn').disabled = true;
    document.getElementById('exportNeortBtn').disabled = true;
    
    saveNextFrame();
}

// æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä¿å­˜
function saveNextFrame() {
    if (saveIndex >= pendingFrames.length) {
        // å…¨ãƒ•ãƒ¬ãƒ¼ãƒ ä¿å­˜å®Œäº†
        completeSave();
        return;
    }
    
    let frame = pendingFrames[saveIndex];
    
    // Data URLã‹ã‚‰Blobã‚’ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    fetch(frame.data)
        .then(res => res.blob())
        .then(blob => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = frame.filename;
            link.click();
            
            // ãƒ¡ãƒ¢ãƒªè§£æ”¾
            URL.revokeObjectURL(link.href);
            
            saveIndex++;
            
            // é€²æ—æ›´æ–°
            document.getElementById('exportFrame').textContent = saveIndex;
            document.getElementById('exportMessage').textContent = `ä¿å­˜ä¸­: ${frame.filename}`;
            let progress = (saveIndex / pendingFrames.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä¿å­˜ï¼ˆé–“éš”ã‚’ç©ºã‘ã¦ï¼‰
            setTimeout(saveNextFrame, 100);  // 100msé–“éš”ã§ä¿å­˜
        })
        .catch(error => {
            console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${frame.filename}\nå†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚`);
            completeSave();
        });
}

// ä¿å­˜å®Œäº†å‡¦ç†
function completeSave() {
    console.log(`ä¿å­˜å®Œäº†: ${saveIndex}/${pendingFrames.length}ãƒ•ãƒ¬ãƒ¼ãƒ `);
    
    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    pendingFrames = [];
    isSaving = false;
    isExporting = false;
    exportFrameCount = 0;
    saveIndex = 0;
    
    if (exportGraphics) {
        exportGraphics.remove();
        exportGraphics = null;
    }
    
    // UIã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('exportStatus').classList.remove('active', 'saving');
    document.getElementById('exportGoogleBtn').disabled = false;
    document.getElementById('exportNeortBtn').disabled = false;
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
    initSeasonData();
    updateCanvasSize();
    
    // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    alert(`æ›¸ãå‡ºã—å®Œäº†ï¼\n${saveIndex}æšã®ç”»åƒãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚\n\nå‹•ç”»åŒ–ã‚³ãƒãƒ³ãƒ‰ï¼š\nffmpeg -r 60 -i ${exportMode}_frame_%04d.png -c:v libx264 -pix_fmt yuv420p -crf 18 ${exportMode}_output.mp4`);
}

// æ›¸ãå‡ºã—é–‹å§‹ï¼ˆGoogle Formç”¨ï¼‰
function exportHighResGoogle() {
    if (isExporting || isSaving) {
        console.log('å‡¦ç†ä¸­ã§ã™');
        return;
    }
    
    console.log('Google Formç”¨ é«˜è§£åƒåº¦æ›¸ãå‡ºã—é–‹å§‹...');
    
    exportMode = 'google';
    isExporting = true;
    exportFrameCount = 0;
    pendingFrames = [];
    exportFlakes = [];
    exportGenerationPhase = 0;
    
    exportGraphics = createGraphics(GOOGLE_CANVAS_W, GOOGLE_CANVAS_H);
    exportGraphics.pixelDensity(1);
    exportGraphics.textFont('monospace');  // â˜…é«˜è§£åƒåº¦ç”¨ã«ã‚‚ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
    
    document.getElementById('exportStatus').classList.add('active');
    document.getElementById('exportStatusText').textContent = 'ğŸ“¸ ãƒ•ãƒ¬ãƒ¼ãƒ ç”Ÿæˆä¸­...';
    document.getElementById('totalFrames').textContent = '900';
    document.getElementById('progressFill').style.width = '0%';
    
    initSeasonData();
}

// æ›¸ãå‡ºã—é–‹å§‹ï¼ˆNEORTç”¨ï¼‰
function exportHighResNeort() {
    if (isExporting || isSaving) {
        console.log('å‡¦ç†ä¸­ã§ã™');
        return;
    }
    
    console.log('NEORTç”¨ é«˜è§£åƒåº¦æ›¸ãå‡ºã—é–‹å§‹...');
    
    exportMode = 'neort';
    isExporting = true;
    exportFrameCount = 0;
    pendingFrames = [];
    exportFlakes = [];
    exportGenerationPhase = 0;
    
    exportGraphics = createGraphics(NEORT_W, NEORT_H);
    exportGraphics.pixelDensity(1);
    exportGraphics.textFont('monospace');  // â˜…é«˜è§£åƒåº¦ç”¨ã«ã‚‚ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
    
    document.getElementById('exportStatus').classList.add('active');
    document.getElementById('exportStatusText').textContent = 'ğŸ“¸ ãƒ•ãƒ¬ãƒ¼ãƒ ç”Ÿæˆä¸­...';
    document.getElementById('totalFrames').textContent = '900';
    document.getElementById('progressFill').style.width = '0%';
    
    initSeasonData();
}

// â˜…æœ€é©åŒ–ã•ã‚ŒãŸæç”»é–¢æ•°
function drawPoetryWork() {
    updateBackground();
    handleTransition();
    if (generationPhase < 3) {
        generateFlakesPhase();
    }
    displayPoetryCode();
    renderFlakesOptimized();  // â˜…æœ€é©åŒ–ç‰ˆã‚’ä½¿ç”¨
}

function drawPoetryWorkHighRes(pg) {
    pg.push();
    
    let totalProgress = (exportFrameCount % 900) / 900.0;
    let seasonIndex = Math.floor(totalProgress * 4);
    let seasonProgress = (totalProgress * 4) % 1;
    
    // â˜…æœ€å¾Œã®ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆ899ï¼‰ã¯æ˜¥ã¨ã—ã¦æ‰±ã†
    let currentSeason, nextSeason;
    if (exportFrameCount === 899) {
        currentSeason = 's';  // æ˜¥
        nextSeason = 'u';     // å¤
        seasonProgress = 0;   // æ˜¥ã®å§‹ã¾ã‚Š
    } else {
        currentSeason = s[seasonIndex % 4];
        nextSeason = s[(seasonIndex + 1) % 4];
    }
    
    drawExportBackground(pg, currentSeason, nextSeason, seasonProgress);
    generateExportFlakesPhase(currentSeason, seasonIndex);
    displayExportPoetryCode(pg, currentSeason);
    renderExportFlakesOptimized(pg);  // â˜…æœ€é©åŒ–ç‰ˆã‚’ä½¿ç”¨
    
    pg.pop();
}

function drawExportBackground(pg, currentSeason, nextSeason, seasonProgress) {
    // æœ€å¾Œã®ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆ899ï¼‰ã®å ´åˆã¯æ˜¥ã®èƒŒæ™¯
    if (exportFrameCount === 899) {
        pg.fill(...d.s.bg);  // æ˜¥ã®èƒŒæ™¯è‰²
        pg.noStroke();
        pg.rect(0, 0, workW, workH);
        return;
    }
    
    let currentBg = color(...d[currentSeason].bg);
    let nextBg = color(...d[nextSeason].bg);
    
    let lerpAmount = seasonProgress < 0.5 ? 0 : map(seasonProgress, 0.5, 1, 0, 1);
    let bg = lerpColor(currentBg, nextBg, lerpAmount);
    
    pg.fill(bg);
    pg.noStroke();
    pg.rect(0, 0, workW, workH);
}

function generateExportFlakesPhase(currentSeason, seasonIndex) {
    let frameInSeason = exportFrameCount % 225;
    let posScale = exportMode === 'google' ? 4 : 9;  // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—ã«ä¿®æ­£
    
    if (frameInSeason === 0) {
        exportFlakes = [];
        for (let i = 0; i < 80; i++) {  // 50ã‹ã‚‰80ã«å¢—åŠ 
            exportFlakes.push(new ExportFlake(
                random(-20, workW + 20),  // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜Xç¯„å›²ã«ä¿®æ­£
                random(-80 * posScale, -5 * posScale),  // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜Yç¯„å›²ã«ä¿®æ­£
                d[currentSeason].c,
                d[currentSeason].co,
                random(d[currentSeason].s * 0.8, d[currentSeason].s * 1.2),
                d[currentSeason].r,
                exportFrameCount
            ));
        }
    }
    
    if (frameInSeason === 24) {
        for (let i = 0; i < 60; i++) {  // 30ã‹ã‚‰60ã«å¢—åŠ 
            exportFlakes.push(new ExportFlake(
                random(-20, workW + 20),  // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜Xç¯„å›²ã«ä¿®æ­£
                random(-60 * posScale, -5 * posScale),  // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜Yç¯„å›²ã«ä¿®æ­£
                d[currentSeason].c,
                d[currentSeason].co,
                random(d[currentSeason].s * 0.7, d[currentSeason].s * 1.1),
                d[currentSeason].r,
                exportFrameCount
            ));
        }
    }
    
    if (frameInSeason === 48) {
        for (let i = 0; i < 40; i++) {  // 20ã‹ã‚‰40ã«å¢—åŠ 
            exportFlakes.push(new ExportFlake(
                random(-20, workW + 20),  // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜Xç¯„å›²ã«ä¿®æ­£
                random(-40 * posScale, -5 * posScale),  // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜Yç¯„å›²ã«ä¿®æ­£
                d[currentSeason].c,
                d[currentSeason].co,
                random(d[currentSeason].s * 0.6, d[currentSeason].s * 1.0),
                d[currentSeason].r,
                exportFrameCount
            ));
        }
    }
}

function displayPoetryCode() {
    push();
    let sizeScale = previewMode === 'google' ? 1 : 2.25;
    
    fill(255, 255, 255, 200);
    textSize(10 * sizeScale);
    textAlign(CENTER, CENTER);
    text(d[cs].code, workW/2, workH/2);
    
    textSize(6 * sizeScale);
    fill(255, 255, 255, 200);
    text("#Computer_Poetry_TOKYO_NODE", workW/2, workH/2 + 15 * sizeScale);
    pop();
}

function displayExportPoetryCode(pg, currentSeason) {
    pg.push();
    let sizeScale = exportMode === 'google' ? 1 : 2.25;
    
    pg.fill(255, 255, 255, 200);
    pg.textSize(40 * sizeScale);
    pg.textAlign(CENTER, CENTER);
    pg.text(d[currentSeason].code, workW/2, workH/2);
    
    pg.textSize(24 * sizeScale);
    pg.fill(255, 255, 255, 200);
    pg.text("#Computer_Poetry_TOKYO_NODE", workW/2, workH/2 + 60 * sizeScale);
    pg.pop();
}

// â˜…æœ€é©åŒ–ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ã‚¯æç”»ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
function renderFlakesOptimized() {
    // ã¾ãšæ›´æ–°ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    f = f.filter(flake => {
        flake.updateOptimized();
        return !flake.isOffscreen();
    });
    
    // æç”»ã®åˆæœŸè¨­å®š
    noStroke();
    textAlign(CENTER, CENTER);
    
    // å›è»¢ã—ãªã„ãƒ•ãƒ¬ãƒ¼ã‚¯ã‚’ã¾ã¨ã‚ã¦æç”»ï¼ˆpush/popä¸è¦ï¼‰
    f.filter(flake => !flake.shouldRotate).forEach(flake => {
        fill(flake.col[0], flake.col[1], flake.col[2], flake.opacity);
        textSize(flake.size);
        text(flake.char, flake.x, flake.y);
    });
    
    // å›è»¢ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ã‚¯ã¯å€‹åˆ¥ã«å‡¦ç†
    f.filter(flake => flake.shouldRotate).forEach(flake => {
        push();
        translate(flake.x, flake.y);
        rotate(flake.rotation);
        fill(flake.col[0], flake.col[1], flake.col[2], flake.opacity);
        textSize(flake.size);
        text(flake.char, 0, 0);
        pop();
    });
}

// â˜…æœ€é©åŒ–ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ã‚¯æç”»ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ï¼‰
function renderExportFlakesOptimized(pg) {
    // æ›´æ–°ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    exportFlakes = exportFlakes.filter(flake => {
        flake.updateExport(exportFrameCount);
        return !flake.isOffscreenExport();
    });
    
    // æç”»ã®åˆæœŸè¨­å®š
    pg.noStroke();
    pg.textAlign(CENTER, CENTER);
    
    // å›è»¢ã—ãªã„ãƒ•ãƒ¬ãƒ¼ã‚¯ã‚’ã¾ã¨ã‚ã¦æç”»
    exportFlakes.filter(flake => !flake.shouldRotate).forEach(flake => {
        pg.fill(flake.col[0], flake.col[1], flake.col[2], flake.opacity);
        pg.textSize(flake.size);
        pg.text(flake.char, flake.x, flake.y);
    });
    
    // å›è»¢ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ã‚¯ã¯å€‹åˆ¥ã«å‡¦ç†
    exportFlakes.filter(flake => flake.shouldRotate).forEach(flake => {
        pg.push();
        pg.translate(flake.x, flake.y);
        pg.rotate(flake.rotation);
        pg.fill(flake.col[0], flake.col[1], flake.col[2], flake.opacity);
        pg.textSize(flake.size);
        pg.text(flake.char, 0, 0);
        pg.pop();
    });
}

class ExportFlake {
    constructor(x, y, char, col, size, rotate, birthFrame) {
        this.x = x;
        this.y = y;
        this.char = char;
        this.col = col;
        this.size = size;
        this.shouldRotate = rotate;
        this.rotation = rotate ? random(TWO_PI) : 0;
        this.birthFrame = birthFrame;
        
        let speedScale = exportMode === 'google' ? 4 : 9;
        
        // è½ä¸‹é€Ÿåº¦ã‚’å­£ç¯€ã”ã¨ã«èª¿æ•´
        let speedGroup = random();
        if (this.char === 'âœ¿') {  // æ˜¥ã¯å°‘ã—é€Ÿã‚ã«è½ã¨ã™
            if (speedGroup < 0.3) {
                this.speed = random(3.0, 4.0) * speedScale;
            } else if (speedGroup < 0.7) {
                this.speed = random(4.0, 5.0) * speedScale;
            } else {
                this.speed = random(5.0, 6.5) * speedScale;
            }
        } else if (this.char === 'â™ ') {  // ç§‹ã¯ã‚†ã£ãã‚Šã¨åºƒãŒã‚ŠãªãŒã‚‰è½ã¡ã‚‹
            if (speedGroup < 0.3) {
                this.speed = random(1.5, 2.5) * speedScale;
            } else if (speedGroup < 0.7) {
                this.speed = random(2.5, 3.5) * speedScale;
            } else {
                this.speed = random(3.5, 4.5) * speedScale;
            }
        } else {
            if (speedGroup < 0.3) {
                this.speed = random(2.5, 3.5) * speedScale;
            } else if (speedGroup < 0.7) {
                this.speed = random(3.5, 4.5) * speedScale;
            } else {
                this.speed = random(4.5, 6) * speedScale;
            }
        }
        
        this.initialSpeed = this.speed;
        this.velocity = rotate ? random(-0.5, 0.5) * speedScale : 0;
        this.opacity = 255;
        this.baseOpacity = random(180, 255);
        this.wobblePhase = random(TWO_PI);

        // å­£ç¯€ã”ã¨ã®æ¨ªç§»å‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        if (this.char === 'âœ¿') {  // æ˜¥ - å›è»¢ã‚’å¤§å¹…ã«å¼·åŒ–
            this.wobbleMultiplier = 0.8;
            this.wobbleSpeed = 0.007;
            this.rotationSpeed = 0.12;  // 0.025ã‹ã‚‰0.12ã«å¢—åŠ ï¼ˆç´„5å€ï¼‰
            this.velocityDamping = 0.997;
            this.horizontalDrift = 0;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            
        } else if (this.char === 'â™ ') {  // ç§‹ - å›è»¢ã‚’å¤§å¹…ã«å¼·åŒ–ã€åºƒãŒã‚‹å‹•ã
            this.wobbleMultiplier = 1.5;  // æ¨ªæºã‚Œã‚’å¤§å¹…ã«å¢—åŠ ï¼ˆ0.25ã‹ã‚‰1.5ã¸ï¼‰
            this.wobbleSpeed = 0.025;
            this.rotationSpeed = 0.18;  // 0.07ã‹ã‚‰0.18ã«å¢—åŠ ï¼ˆç´„2.5å€ï¼‰
            this.velocityDamping = 0.995;  // æ¸›é€Ÿã‚’ç·©ã‚„ã‹ã«ï¼ˆ0.985ã‹ã‚‰0.995ã¸ï¼‰
            this.erraticOffset = random(TWO_PI);
            this.horizontalDrift = random(-2, 2) * speedScale;  // æ¨ªæ–¹å‘ã¸ã®æ¼‚æµã‚’è¿½åŠ 
            
        } else {
            this.wobbleMultiplier = 0.15;
            this.wobbleSpeed = 0.01;
            this.rotationSpeed = 0.03;
            this.velocityDamping = 1.0;
            this.horizontalDrift = 0;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        }
    }
    
    updateExport(currentFrame) {
        let framesSinceBirth = currentFrame - this.birthFrame;
        
        // æ˜¥ã®è½ä¸‹åŠ é€Ÿã‚’å°‘ã—å¼·ãã€ç§‹ã¯ã»ã¼ç­‰é€Ÿ
        if (this.char === 'âœ¿') {
            this.speed = this.initialSpeed * Math.pow(1.003, framesSinceBirth);
        } else if (this.char === 'â™ ') {  // ç§‹ã¯åŠ é€Ÿã‚’ã»ã¼ãªã—ã«
            this.speed = this.initialSpeed * Math.pow(1.0005, framesSinceBirth);
        } else {
            this.speed = this.initialSpeed * Math.pow(1.002, framesSinceBirth);
        }
        
        this.y += this.speed;
        
        // â˜…é‡è¦ï¼šcurrentFrameï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰ã‚’ä½¿ç”¨ã—ã¦è¿«åŠ›ã‚ã‚‹åŒæœŸã—ãŸå‹•ãã‚’å®Ÿç¾
        if (this.char === 'âœ¿') {  // æ˜¥ - ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ ã§åŒæœŸ
            let yInfluenceScale = exportMode === 'google' ? 0.001 : 0.00022;  // â˜…Yåº§æ¨™ã®å½±éŸ¿ã‚’è§£åƒåº¦ã«å¿œã˜ã¦èª¿æ•´
            this.x += Math.sin(currentFrame * this.wobbleSpeed + this.y * yInfluenceScale) * this.wobbleMultiplier;
            this.x += this.horizontalDrift || 0;  // æ¨ªæ–¹å‘ã¸ã®æ¼‚æµã‚’è¿½åŠ 
            this.velocity *= this.velocityDamping;
            this.x += this.velocity;
            
        } else if (this.char === 'â™ ') {  // ç§‹ - ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ ã§åŒæœŸ
            let wobbleScale = exportMode === 'google' ? 4 : 9;  // â˜…æ¨ªæºã‚Œç”¨ã®ã‚¹ã‚±ãƒ¼ãƒ«
            let yInfluenceScale = exportMode === 'google' ? 0.002 : 0.00044;  // â˜…Yåº§æ¨™ã®å½±éŸ¿ã‚’è§£åƒåº¦ã«å¿œã˜ã¦èª¿æ•´
            this.x += Math.sin(currentFrame * this.wobbleSpeed + this.y * yInfluenceScale) * this.wobbleMultiplier;
            this.x += Math.cos(currentFrame * 0.04 + this.erraticOffset) * 0.5 * wobbleScale;  // â˜…ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨
            this.x += this.horizontalDrift || 0;  // æ¨ªæ–¹å‘ã¸ã®æ¼‚æµã‚’è¿½åŠ 
            this.velocity *= this.velocityDamping;
            this.x += this.velocity;
            
        } else {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆå¤ãƒ»å†¬ï¼‰- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ ã§åŒæœŸ
            let yInfluenceScale = exportMode === 'google' ? 0.002 : 0.00044;  // â˜…Yåº§æ¨™ã®å½±éŸ¿ã‚’è§£åƒåº¦ã«å¿œã˜ã¦èª¿æ•´
            this.x += Math.sin(currentFrame * 0.01 + this.y * yInfluenceScale) * this.wobbleMultiplier;
            this.x += this.horizontalDrift || 0;  // æ¨ªæ–¹å‘ã¸ã®æ¼‚æµï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯0ï¼‰
            this.x += this.velocity;
        }

        if (this.shouldRotate) {
            this.rotation += this.rotationSpeed;
        }
        
        // â˜…æœ€é©åŒ–ã•ã‚ŒãŸé€æ˜åº¦è¨ˆç®—
        if (this.y > workH * 0.7) {
            let fadeRange = workH * 0.3;
            let fadeProgress = (this.y - workH * 0.7) / fadeRange;
            this.opacity = this.baseOpacity * (1 - fadeProgress);
        } else {
            this.opacity = this.baseOpacity;
        }
    }
    
    isOffscreenExport() {
        // é€æ˜åº¦ãŒ0ã«ãªã£ãŸã‚‰å‰Šé™¤
        if (this.opacity <= 0) return true;
        // ç”»é¢å¤–ã«å‡ºãŸã‚‰å‰Šé™¤
        return this.y > workH + 20 || this.x < -100 || this.x > workW + 100;  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜åˆ¤å®šç¯„å›²ã«å¤‰æ›´
    }
}

function updateBackground() {
    let elapsed = millis() - seasonStartTime;
    l = min(elapsed / SEASON_DURATION, 1.0);
    
    let currentBg = color(...d[cs].bg);
    let nextBg = color(...d[ns].bg);
    
    let lerpAmount = l < 0.5 ? 0 : map(l, 0.5, 1, 0, 1);
    let bg = lerpColor(currentBg, nextBg, lerpAmount);
    
    fill(bg);
    noStroke();
    rect(0, 0, workW, workH);
}

function handleTransition() {
    if (l >= 1) {
        cs = ns;
        let currentIndex = s.indexOf(cs);
        let nextIndex = (currentIndex + 1) % 4;
        ns = s[nextIndex];
        
        seasonStartTime = millis();
        l = 0;
        f = [];
        generateFlakes();
    }
}

function generateFlakes() {
    generationPhase = 0;
    generateFlakesPhase();
}

function generateFlakesPhase() {
    let elapsed = millis() - seasonStartTime;
    
    let posScale = isExporting ? 
        (exportMode === 'google' ? 4 : 9) : 
        (previewMode === 'google' ? 1 : 2.25);
    
    if (generationPhase === 0) {
        for (let i = 0; i < 80; i++) {  // 50ã‹ã‚‰80ã«å¢—åŠ 
            f.push(new Flake(
                random(-20, workW + 20),
                random(-80 * posScale, -5 * posScale),
                d[cs].c,
                d[cs].co,
                random(d[cs].s * 0.8, d[cs].s * 1.2),
                d[cs].r
            ));
        }
        generationPhase = 1;
    } else if (generationPhase === 1 && elapsed > 400) {
        for (let i = 0; i < 60; i++) {  // 30ã‹ã‚‰60ã«å¢—åŠ 
            f.push(new Flake(
                random(-20, workW + 20),
                random(-60 * posScale, -5 * posScale),
                d[cs].c,
                d[cs].co,
                random(d[cs].s * 0.7, d[cs].s * 1.1),
                d[cs].r
            ));
        }
        generationPhase = 2;
    } else if (generationPhase === 2 && elapsed > 800) {
        for (let i = 0; i < 40; i++) {  // 20ã‹ã‚‰40ã«å¢—åŠ 
            f.push(new Flake(
                random(-20, workW + 20),
                random(-40 * posScale, -5 * posScale),
                d[cs].c,
                d[cs].co,
                random(d[cs].s * 0.6, d[cs].s * 1.0),
                d[cs].r
            ));
        }
        generationPhase = 3;
    }
}

class Flake {
    constructor(x, y, char, col, size, rotate) {
        this.x = x;
        this.y = y;
        this.char = char;
        this.col = col;
        this.size = size;
        this.shouldRotate = rotate;
        this.rotation = rotate ? random(TWO_PI) : 0;
        
        let speedScale = isExporting ? 
            (exportMode === 'google' ? 4 : 9) : 
            (previewMode === 'google' ? 1 : 2.25);
        
        // è½ä¸‹é€Ÿåº¦ã‚’å­£ç¯€ã”ã¨ã«èª¿æ•´
        let speedGroup = random();
        if (this.char === 'âœ¿') {  // æ˜¥ã¯å°‘ã—é€Ÿã‚ã«è½ã¨ã™
            if (speedGroup < 0.3) {
                this.speed = random(3.0, 4.0) * speedScale;
            } else if (speedGroup < 0.7) {
                this.speed = random(4.0, 5.0) * speedScale;
            } else {
                this.speed = random(5.0, 6.5) * speedScale;
            }
        } else if (this.char === 'â™ ') {  // ç§‹ã¯ã‚†ã£ãã‚Šã¨åºƒãŒã‚ŠãªãŒã‚‰è½ã¡ã‚‹
            if (speedGroup < 0.3) {
                this.speed = random(1.5, 2.5) * speedScale;
            } else if (speedGroup < 0.7) {
                this.speed = random(2.5, 3.5) * speedScale;
            } else {
                this.speed = random(3.5, 4.5) * speedScale;
            }
        } else {
            if (speedGroup < 0.3) {
                this.speed = random(2.5, 3.5) * speedScale;
            } else if (speedGroup < 0.7) {
                this.speed = random(3.5, 4.5) * speedScale;
            } else {
                this.speed = random(4.5, 6) * speedScale;
            }
        }
        
        this.velocity = rotate ? random(-0.5, 0.5) * speedScale : 0;
        this.opacity = 255;
        this.baseOpacity = random(180, 255);

        // å­£ç¯€ã”ã¨ã®æ¨ªç§»å‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        if (this.char === 'âœ¿') {  // æ˜¥ - å›è»¢ã‚’å¤§å¹…ã«å¼·åŒ–
            this.wobbleMultiplier = 0.8;
            this.wobbleSpeed = 0.007;
            this.rotationSpeed = 0.12;  // 0.025ã‹ã‚‰0.12ã«å¢—åŠ ï¼ˆç´„5å€ï¼‰
            this.velocityDamping = 0.997;
            this.horizontalDrift = 0;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            
        } else if (this.char === 'â™ ') {  // ç§‹ - å›è»¢ã‚’å¤§å¹…ã«å¼·åŒ–ã€åºƒãŒã‚‹å‹•ã
            this.wobbleMultiplier = 1.5;  // æ¨ªæºã‚Œã‚’å¤§å¹…ã«å¢—åŠ ï¼ˆ0.25ã‹ã‚‰1.5ã¸ï¼‰
            this.wobbleSpeed = 0.025;
            this.rotationSpeed = 0.18;  // 0.07ã‹ã‚‰0.18ã«å¢—åŠ ï¼ˆç´„2.5å€ï¼‰
            this.velocityDamping = 0.995;  // æ¸›é€Ÿã‚’ç·©ã‚„ã‹ã«ï¼ˆ0.985ã‹ã‚‰0.995ã¸ï¼‰
            this.erraticOffset = random(TWO_PI);
            this.horizontalDrift = random(-2, 2) * speedScale;  // æ¨ªæ–¹å‘ã¸ã®æ¼‚æµã‚’è¿½åŠ 
            
        } else {
            this.wobbleMultiplier = 0.15;
            this.wobbleSpeed = 0.01;
            this.rotationSpeed = 0.03;
            this.velocityDamping = 1.0;
            this.horizontalDrift = 0;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        }
        
        // â˜…æœ€é©åŒ–ï¼šsin/cosç”¨ã®ä½ç›¸ã‚’äº‹å‰è¨ˆç®—
        this.sinPhase = 0;
        this.cosPhase = 0;
    }
    
    // â˜…æœ€é©åŒ–ã•ã‚ŒãŸupdateé–¢æ•°
    updateOptimized() {
        // æ˜¥ã®è½ä¸‹åŠ é€Ÿã‚’å°‘ã—å¼·ãã€ç§‹ã¯ã»ã¼ç­‰é€Ÿ
        if (this.char === 'âœ¿') {
            this.speed *= 1.003;
        } else if (this.char === 'â™ ') {  // ç§‹ã¯åŠ é€Ÿã‚’ã»ã¼ãªã—ã«
            this.speed *= 1.0005;
        } else {
            this.speed *= 1.002;
        }
        
        this.y += this.speed;
        
        // æ˜¥ã¨ç§‹ã§ç•°ãªã‚‹æ¨ªç§»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³
        if (this.char === 'âœ¿') {  // æ˜¥
            this.sinPhase = frameCounter * this.wobbleSpeed + this.y * 0.005;
            this.x += Math.sin(this.sinPhase) * this.wobbleMultiplier;
            this.x += this.horizontalDrift || 0;  // æ¨ªæ–¹å‘ã¸ã®æ¼‚æµã‚’è¿½åŠ 
            this.velocity *= this.velocityDamping;
            this.x += this.velocity;
            
        } else if (this.char === 'â™ ') {  // ç§‹
            this.sinPhase = frameCounter * this.wobbleSpeed + this.y * 0.01;
            this.cosPhase = frameCounter * 0.04 + this.erraticOffset;
            this.x += Math.sin(this.sinPhase) * this.wobbleMultiplier;
            this.x += Math.cos(this.cosPhase) * 0.5;  // 0.2ã‹ã‚‰0.5ã«å¢—åŠ 
            this.x += this.horizontalDrift || 0;  // æ¨ªæ–¹å‘ã¸ã®æ¼‚æµã‚’è¿½åŠ 
            this.velocity *= this.velocityDamping;
            this.x += this.velocity;
            
        } else {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆå¤ãƒ»å†¬ï¼‰
            this.x += Math.sin(frameCounter * 0.01 + this.y * 0.01) * this.wobbleMultiplier;
            this.x += this.horizontalDrift || 0;  // æ¨ªæ–¹å‘ã¸ã®æ¼‚æµï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯0ï¼‰
            this.x += this.velocity;
        }

        if (this.shouldRotate) {
          this.rotation += this.rotationSpeed;
        }
        
        // â˜…æœ€é©åŒ–ã•ã‚ŒãŸé€æ˜åº¦è¨ˆç®—
        if (this.y > workH * 0.7) {
            let fadeRange = workH * 0.3;
            let fadeProgress = (this.y - workH * 0.7) / fadeRange;
            this.opacity = this.baseOpacity * (1 - fadeProgress);
        } else {
            this.opacity = this.baseOpacity;
        }
    }
    
    isOffscreen() {
        return this.y > workH + 20 || this.x < -100 || this.x > workW + 100;
    }
}

function drawGuides() {
    push();
    
    stroke(0, 255, 255, 100);
    strokeWeight(1);
    noFill();
    
    if (previewMode === 'google') {
        rect(0, 0, GOOGLE_WORK_W * WORK_SCALE, GOOGLE_WORK_H * WORK_SCALE);
    } else {
        rect(0, 0, workW, workH);
    }
    
    stroke(255, 0, 255, 50);
    line(previewW / 2, 0, previewW / 2, previewH);
    line(0, previewH / 2, previewW, previewH / 2);
    
    fill(0, 255, 255);
    noStroke();
    textSize(10);
    textAlign(LEFT, TOP);
    
    if (previewMode === 'google') {
        text(`ä½œå“: ${GOOGLE_WORK_W}Ã—${GOOGLE_WORK_H}`, 5, GOOGLE_WORK_H * WORK_SCALE + 5);
        text(`ã‚­ãƒ£ãƒ³ãƒã‚¹: ${GOOGLE_CANVAS_W}Ã—${GOOGLE_CANVAS_H}`, 5, GOOGLE_WORK_H * WORK_SCALE + 20);
        text('å·¦ä¸Šé…ç½® (Google Formç”¨)', 5, GOOGLE_WORK_H * WORK_SCALE + 35);
    } else {
        text(`ä½œå“: ${NEORT_W}Ã—${NEORT_H}`, 5, 5);
        text('å…¨ç”»é¢ (NEORTç”¨)', 5, 20);
        text('ä½™ç™½ãªã—', 5, 35);
    }
    
    pop();
}

function updateUI() {
    document.getElementById('fps').textContent = Math.round(frameRate());
    document.getElementById('currentSeason').textContent = d[cs].name;
    
    let modeElement = document.getElementById('previewModeText');
    if (modeElement) {
        modeElement.textContent = previewMode === 'google' ? 'Google Formç”¨' : 'NEORTç”¨';
    }
    
    let sizeElement = document.getElementById('workSizeText');
    if (sizeElement) {
        if (previewMode === 'google') {
            sizeElement.textContent = `${GOOGLE_WORK_W}Ã—${GOOGLE_WORK_H}`;
        } else {
            sizeElement.textContent = `${NEORT_W}Ã—${NEORT_H}`;
        }
    }
}

// ===============================================
// æ“ä½œé–¢æ•°
// ===============================================
function togglePreviewMode() {
    previewMode = previewMode === 'google' ? 'neort' : 'google';
    updateCanvasSize();
    resizeCanvas(previewW, previewH);
    
    initSeasonData();
    
    console.log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸï¼š', previewMode === 'google' ? 'Google Formç”¨' : 'NEORTç”¨');
    updateUI();
}

function toggleGuide() {
    showGuide = !showGuide;
}

function resetAnimation() {
    frameCounter = 0;
    l = 0;
    cs = 's';
    ns = 'u';
    f = [];
    generationPhase = 0;
    seasonStartTime = millis();
    generateFlakes();
}

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
function keyPressed() {
    if (key === 'm' || key === 'M') {
        togglePreviewMode();
    } else if (key === 'g' || key === 'G') {
        toggleGuide();
    } else if (key === 'r' || key === 'R') {
        resetAnimation();
    } else if (key === 's' || key === 'S') {
        let prefix = previewMode === 'google' ? 'google_preview_' : 'neort_preview_';
        saveCanvas(prefix + 'poetry_computer_' + frameCount, 'png');
        console.log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }
}
</script>
</body>
</html>
